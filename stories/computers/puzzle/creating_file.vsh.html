<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>creating_file.vsh</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v2">
<meta name="syntax" content="none">
<meta name="settings" content="use_css,no_foldcolumn,expand_tabs,prevent_copy=">
<meta name="colorscheme" content="techras">
<style type="text/css">
<!--
pre { font-family: monospace; color: #ffffff; background-color: #000000; }
body { font-family: monospace; color: #ffffff; background-color: #000000; }
* { font-size: 1em; }
.Comment { color: #005fff; }
.PreProc { color: #c000c0; }
.String { color: #c00000; }
-->
</style>

</head>
<body>
<pre id='vimCodeElement'>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Create an executable ELF file</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> as elfhdr.s -o aself.o</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> ld -Ttext 0x08048000 --oformat=binary -o elffile.out aself.o</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> chmod +x ./elffile.out</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> echo &amp;&amp; ./elffile.out</span>
puzzle [12:12:12] $ puzzle [12:12:12] $ puzzle [12:12:12] $
My words may be obtuse.
But they reveal a truth.
Read them carefully and give me a ...
puzzle [12:12:12] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> file elffile.out</span>
elffile.out: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, stripped, with debug_info
puzzle [12:12:15] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Create a valid mbr .</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> as mbr_message.s -o asmbr.o</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> ld -Ttext 0x7c00 --oformat=binary -o asmbr.out asmbr.o</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> qemu-system-x86_64 -enable-kvm -drive file=asmbr.out,index=0,if=floppy,format=raw -boot order=a</span>
puzzle [12:12:17] $ puzzle [12:12:17] $ puzzle [12:12:19] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> python</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> import itertools</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> with open(</span><span class="String">'elffile.out'</span><span class="Comment">, </span><span class="String">'rb'</span><span class="Comment">) as infile:</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment">   elfbytes = infile.read()^M</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> with open(</span><span class="String">'asmbr.out'</span><span class="Comment">, </span><span class="String">'rb'</span><span class="Comment">) as infile:</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment">   mbrbytes = infile.read()^M</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> with open(</span><span class="String">'final.bin'</span><span class="Comment">, </span><span class="String">'wb'</span><span class="Comment">) as outfile:</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment">   for pos, (left, right) in enumerate(itertools.zip_longest(mbrbytes, elfbytes, fillvalue=0)):</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment">       if left != 0 and right != 0 and left != right:</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment">           print(</span><span class="String">&quot;\nFailure at byte position&quot;</span><span class="Comment">, hex(pos))</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment">           print(</span><span class="String">&quot;mbr value: &quot;</span><span class="Comment">, hex(left))</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment">           print(</span><span class="String">&quot;ELF value: &quot;</span><span class="Comment">, hex(right))</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment">   outfile.write(bytes([ left | right for left, right in itertools.zip_longest(mbrbytes, elfbytes, fillvalue=0)]))^M</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> exit()</span>
Python 3.6.0 (default, Jan 16 2017, 12:12:55)
[GCC 6.3.1 20170109] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; &gt;&gt;&gt; ... ... &gt;&gt;&gt; ... ... &gt;&gt;&gt; ... ... ... ... ... ... ... 1024
&gt;&gt;&gt; puzzle [12:12:21] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Check that output file works as an mbr</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> chmod u+x final.bin &amp;&amp; ./final.bin</span>
My words may be obtuse.
But they reveal a truth.
Read them carefully and give me a ...
puzzle [12:12:24] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> qemu-system-x86_64 -enable-kvm -drive file=final.bin,index=0,if=floppy,format=raw -boot order=a</span>
puzzle [12:12:27] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # N.B. this requires a bochsrc.txt -- just use the most plain one you find via google.</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> bochs</span>
========================================================================
                       Bochs x86 Emulator 2.6.8
                Built from SVN snapshot on May 3, 2015
                  Compiled on Nov  7 2016 at 17:36:50
========================================================================
00000000000i[      ] BXSHARE not set. using compile time default '/usr/share/bochs'
00000000000i[      ] reading configuration from bochsrc.txt
------------------------------
Bochs Configuration: Main Menu
------------------------------

This is the Bochs Configuration Interface, where you can describe the
machine that you want to simulate.  Bochs has already searched for a
configuration file (typically called bochsrc.txt) and loaded it if it
could be found.  When you are satisfied with the configuration, go
ahead and start the simulation.

You can also start bochs with the -q option to skip these menus.

1. Restore factory default configuration
2. Read options from...
3. Edit options
4. Save options to...
5. Restore the Bochs state from...
6. Begin simulation
7. Quit now

Please choose one: [6]
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> 6</span>
00000000000i[      ] installing x module as the Bochs GUI
00000000000i[      ] using log file bochsout.txt
Next at t=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt;
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> cont</span>
========================================================================
Bochs is exiting with the following message:
[XGUI  ] POWER button turned off.
========================================================================
(0).[96024000] [0x000000007d12] 0000:7d12 (unk. ctxt): jmp .-2 (0x00007d12)      ; ebfe
puzzle [12:12:34] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Check that it works as a binary</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> chmod u+x final.bin &amp;&amp; ./final.bin</span>
My words may be obtuse.
But they reveal a truth.
Read them carefully and give me a ...
puzzle [12:12:37] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Show that the file isn't too suspicious</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> file final.bin</span>
final.bin: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, stripped, with debug_info
puzzle [12:12:41] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> readelf -a final.bin</span>
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 e9 e4 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       233
  Type:                              EXEC (Executable file)
  Machine:                           Intel 80386
  Version:                           0x1
  Entry point address:               0x804816c
  Start of program headers:          59 (bytes into file)
  Start of section headers:          91 (bytes into file)
  Flags:                             0x0
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         1
  Size of section headers:           40 (bytes)
  Number of section headers:         3
  Section header string table index: 2

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        0804816c 00016c 000294 00   A  0   0 16
  [ 2] .shstrtab         STRTAB          00000000 0000d3 00001b 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  p (processor specific)

There are no section groups in this file.

Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  LOAD           0x000000 0x08048000 0x0800a5e9 0x00400 0x00400 R E 0x1000

 Section to Segment mapping:
  Segment Sections...
   00     .text

There is no dynamic section in this file.

There are no relocations in this file.

The decoding of unwind sections for machine type Intel 80386 is not currently supported.

No version information found in this file.
puzzle [12:12:42] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> objdump -x final.bin</span>

final.bin:     file format elf32-i386
final.bin
architecture: i386, flags 0x00000102:
EXEC_P, D_PAGED
start address 0x0804816c

Program Header:
    LOAD off    0x00000000 vaddr 0x08048000 paddr 0x0800a5e9 align 2**12
         filesz 0x00000400 memsz 0x00000400 flags r-x

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .text         00000294  0804816c  0800a755  0000016c  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
SYMBOL TABLE:
no symbols


puzzle [12:12:44] $
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
