<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>fake_password.vsh</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v2">
<meta name="syntax" content="none">
<meta name="settings" content="use_css,no_foldcolumn,expand_tabs,prevent_copy=">
<meta name="colorscheme" content="techras">
<style type="text/css">
<!--
pre { font-family: monospace; color: #ffffff; background-color: #000000; }
body { font-family: monospace; color: #ffffff; background-color: #000000; }
* { font-size: 1em; }
.Comment { color: #005fff; }
.PreProc { color: #c000c0; }
.String { color: #c00000; }
-->
</style>

</head>
<body>
<pre id='vimCodeElement'>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> gcc -Wall -W -Werror -o test_password{,.c}</span>
fake_plt [17:38:03] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Original file works as expected</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> ./test_password </span><span class="String">'password'</span>
Sorry, that's the wrong password
fake_plt [17:38:05] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> ./test_password </span><span class="String">'funsies!'</span>
Sorry, that's the wrong password
fake_plt [17:38:05] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> ./test_password </span><span class="String">'etmrhdr '</span>
Congratulations!!!
fake_plt [17:38:06] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Get the addresses we need.</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> readelf -r test_password</span>

Relocation section '.rela.dyn' at offset 0x3a0 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000600ff0  000200000006 R_X86_64_GLOB_DAT 0000000000000000 __libc_start_main@GLIBC_2.2.5 + 0
000000600ff8  000400000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0

Relocation section '.rela.plt' at offset 0x3d0 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000601018  000100000007 R_X86_64_JUMP_SLO 0000000000000000 puts@GLIBC_2.2.5 + 0
000000601020  000300000007 R_X86_64_JUMP_SLO 0000000000000000 strcmp@GLIBC_2.2.5 + 0
fake_plt [17:38:08] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> readelf --hex-dump=.got.plt test_password</span>

Hex dump of section '.got.plt':
 NOTE: This section has relocations against it, but these have NOT been applied to this dump.
  0x00601000 200e6000 00000000 00000000 00000000  .`.............
  0x00601010 00000000 00000000 36044000 00000000 ........6.@.....
  0x00601020 46044000 00000000                   F.@.....

fake_plt [17:38:11] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> objdump -h test_password | grep -E -A 1 \(Sections\|.got.plt\)</span>
Sections:
Idx Name          Size      VMA               LMA               File off  Algn
--
 22 .got.plt      00000028  0000000000601000  0000000000601000  00001000  2**3
                  CONTENTS, ALLOC, LOAD, DATA
fake_plt [17:41:40] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> objdump -j .plt -d test_password</span>

test_password:     file format elf64-x86-64


Disassembly of section .plt:

0000000000400420 &lt;.plt&gt;:
  400420:   ff 35 e2 0b 20 00       pushq  0x200be2(%rip)        # 601008 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;
  400426:   ff 25 e4 0b 20 00       jmpq   *0x200be4(%rip)        # 601010 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;
  40042c:   0f 1f 40 00             nopl   0x0(%rax)

0000000000400430 &lt;puts@plt&gt;:
  400430:   ff 25 e2 0b 20 00       jmpq   *0x200be2(%rip)        # 601018 &lt;puts@GLIBC_2.2.5&gt;
  400436:   68 00 00 00 00          pushq  $0x0
  40043b:   e9 e0 ff ff ff          jmpq   400420 &lt;.plt&gt;

0000000000400440 &lt;strcmp@plt&gt;:
  400440:   ff 25 da 0b 20 00       jmpq   *0x200bda(%rip)        # 601020 &lt;strcmp@GLIBC_2.2.5&gt;
  400446:   68 01 00 00 00          pushq  $0x1
  40044b:   e9 d0 ff ff ff          jmpq   400420 &lt;.plt&gt;
fake_plt [17:38:30] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> cp test_password patchedbinary</span>
fake_plt [17:39:02] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Reloc is 0x601020 (easier than calculting the jump from strcmp@plt)</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # memory location of .got.plt is 601000</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # offset into file is 1000</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Take off memory location of .got.plt from reloc, and add back on offset into file.</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> offset=$(python -c </span><span class="String">'print(0x1020)'</span><span class="Comment">)</span>
fake_plt [17:43:15] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Address of __exit_elf64 is 0x400546 -- write these bytes into the .got position.</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> objdump -d test_password | grep exit_elf64 | head -1</span>
0000000000400546 &lt;___exit_elf64&gt;:
fake_plt [17:38:54] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> python -c </span><span class="String">'import sys; sys.stdout.buffer.write(b&quot;\x46\x05\x40&quot;)'</span><span class="Comment">  | dd of=patchedbinary bs=1 seek=$offset conv=notrunc</span>
3+0 records in
3+0 records out
3 bytes copied, 0.07006 s, 0.0 kB/s
fake_plt [17:43:16] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> # Check the patched binary behaves as expected</span>
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> ./patchedbinary </span><span class="String">'etmrhdr '</span>
Sorry, that's the wrong password
fake_plt [17:43:28] $
<span class="PreProc">vshcmd: &gt;</span><span class="Comment"> ./patchedbinary </span><span class="String">'funsies!'</span>
Congratulations!!!
fake_plt [17:43:30] $
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
